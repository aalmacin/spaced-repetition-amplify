<div class="card-manager">
  <app-loading *ngIf="loading; else cardManager"></app-loading>
  <ng-template #cardManager>
    <ng-container>
      <h2 class="header">Card Manager</h2>

      <div class="cards-container">
        <div class="errors">
          <al-alert [messages]="errors" type="error"></al-alert>
        </div>
        <div class="messages">
          <al-alert [messages]="messages" type="success"></al-alert>
        </div>
        <div class="togglers">
          <!-- <input type="checkbox" id="add-card-toggle" class="add-card-toggle" /> -->
          <input type="checkbox" id="filter-toggle" class="filter-toggle" />
          <label class="add-card-toggler" for="add-card-toggle">
            <!-- Add Card -->
            <!-- <i class="fas fa-plus-square"></i> -->
          </label>
          <label *ngIf="cards.length > 0" class="filter-toggler" for="filter-toggle">
            Filter
            <i class="fas fa-filter"></i>
          </label>

          <div class="add-card">
            <form class="add-card__form" [formGroup]="addCardForm" (submit)="addNewCard()">
              <div class="errors">
                <ng-container *ngIf="addCardForm.status === 'INVALID'">
                  <al-alert [messages]="['Front, back, and topic required']" type="error"></al-alert>
                </ng-container>
              </div>
              <input
                #front
                class="add-card__front"
                formControlName="front"
                name="front"
                placeholder="Ex. What is life? (Front/Question)"
              />
              <textarea
                #back
                rows="4"
                class="add-card__back"
                formControlName="back"
                name="back"
                placeholder="Ex. 42 is the meaning of life according to Hitchikers Guide to the Galaxy (Back/Answer)"
              ></textarea>

              <select class="add-card__topic" formControlName="topicId" name="topicId">
                <option value="">Select Topic</option>
                <option *ngFor="let topic of topics" [value]="topic.id">{{ topic.name }}</option>
              </select>

              <button
                class="add-card__submit"
                [disabled]="addCardForm.status === 'INVALID'"
                alBtn="primary"
                size="fit"
                type="secondary"
              >
                Create Card
              </button>
            </form>
          </div>

          <div class="filter">
            <div class="filter__container">
              <div class="filter__field">
                <label for="search" class="al-semibold">Filter</label>
              </div>

              <div class="filter__field">
                <input
                  (input)="changeSearchTerm(searchTerm.value)"
                  #searchTerm
                  id="search"
                  class="filter__input filter__input--search"
                  type="text"
                  placeholder="Search Term: Topic Name/Front/Back"
                />
              </div>

              <div class="filter__field">
                <input
                  (change)="changeIsReadyStudy()"
                  #readyStudyOnly
                  id="study"
                  class="filter__study"
                  type="checkbox"
                  [checked]="isReadyStudyOnly"
                />
                <label for="study">Ready to Study?</label>
              </div>
            </div>
          </div>
        </div>

        <ng-container *ngIf="(filteredCards | async).length > 0; else noCards">
          <div class="card-header">
            <div class="card-header__topic-name">Topic Name</div>
            <div class="card-header__front">Front</div>
            <div class="card-header__back">Back</div>
            <div class="card-header__box">Box</div>
            <div class="card-header__ready">Ready to Study</div>
            <div class="card-header__next-study">Next Study</div>
            <div class="card-header__action"></div>
          </div>
          <div class="cards" *ngFor="let card of filteredCards | async; let i = index">
            <input id="toggle-{{ i }}" class="card-toggle" type="checkbox" />
            <div class="card card--collapsed">
              <div class="card__topic-name">{{ card.topicName }}</div>
              <div class="card__front al-ellipsis">{{ card.front }}</div>
              <div class="card__back al-ellipsis">{{ card.back }}</div>
              <div class="card__box">
                {{ card.box }}
              </div>
              <div class="card__ready">
                {{ card.isReadyToStudy ? 'yes' : 'no' }}
              </div>
              <div class="card__next-study">
                {{ card.nextStudyDate }}
              </div>
              <label for="toggle-{{ i }}" class="card__action card__action--expand"
                ><i class="fas fa-caret-left"></i
              ></label>
              <label for="toggle-{{ i }}" class="card__action card__action--collapse"
                ><i class="fas fa-caret-down"></i
              ></label>
            </div>
            <div class="card card--expanded">
              <div class="card-info">
                <div class="card-info__fields">
                  <input type="checkbox" class="card-info__toggle" id="toggle-form-{{ i }}" />
                  <div class="card-info__field card-info__field--topic">
                    <span class="al-semibold card-info__label">Topic:</span>
                    <span class="card-info__value">
                      {{ card.topicName }}
                    </span>
                    <span class="card-info__value card-info__form">
                      <select #infoTopic>
                        <option
                          [selected]="topic.id === card.topicId"
                          *ngFor="let topic of topics"
                          [value]="topic.id"
                          >{{ topic.name }}</option
                        >
                      </select>
                    </span>
                  </div>
                  <div class="card-info__field card-info__field--front">
                    <span class="al-semibold">Front:</span>
                    <span class="card-info__value card-info__display">
                      <pre>{{ card.front }}</pre>
                    </span>
                    <span class="card-info__value card-info__form">
                      <textarea class="card-info__update-input" type="text" #infoFront>{{ card.front }}</textarea>
                    </span>
                  </div>
                  <div class="card-info__field card-info__field--back">
                    <span class="al-semibold">Back:</span>
                    <span class="card-info__value card-info__display">
                      <pre>{{ card.back }}</pre>
                    </span>
                    <span class="card-info__value card-info__form">
                      <textarea class="card-info__update-input" type="text" #infoBack>{{ card.back }}</textarea>
                    </span>
                  </div>
                  <div class="card-info__field card-info__field--box">
                    <span class="al-semibold">Box:</span>
                    <span class="card-info__value">
                      {{ card.box }}
                    </span>
                  </div>
                  <div class="card-info__field card-info__field--ready">
                    <span class="al-semibold">Ready to study:</span>
                    <span class="card-info__value">
                      {{ card.isReadyToStudy ? 'yes' : 'no' }}
                    </span>
                  </div>
                  <div class="card-info__field card-info__field--last-study">
                    <span class="al-semibold">Last Study:</span>
                    <span class="card-info__value">
                      {{ card.lastStudyDate }}
                    </span>
                  </div>
                  <div class="card-info__field card-info__field--next-study">
                    <span class="al-semibold">Next Study:</span>
                    <span class="card-info__value">
                      {{ card.nextStudyDate }}
                    </span>
                  </div>
                  <div class="card-info__actions">
                    <label
                      for="toggle-form-{{ i }}"
                      class="card-info__action card-info__action--edit"
                      alBtn="secondary"
                      size="tiny"
                      ><i class="far fa-edit"></i> Edit</label
                    >
                    <label
                      for="toggle-form-{{ i }}"
                      class="card-info__action card-info__action--save"
                      alBtn="tertiary"
                      size="tiny"
                      (click)="updateCard(card.id, infoTopic.value, infoFront.value, infoBack.value)"
                      ><i class="far fa-save"></i> Save</label
                    >
                    <label
                      for="toggle-form-{{ i }}"
                      class="card-info__action card-info__action--cancel"
                      alBtn="plain"
                      size="tiny"
                      ><i class="far fa-window-close"></i> Cancel</label
                    >
                    <a class="card-info__action" alBtn="alert" size="tiny" (click)="deleteCard($event, card.id)"
                      ><i class="far fa-trash-alt"></i> Delete</a
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </div>
    </ng-container>
  </ng-template>
</div>

<ng-template #noCards>
  <div class="no-cards">
    <div class="no-cards__icon">
      <i class="fas fa-couch"></i>
    </div>
    <p class="no-cards__message">
      No cards yet. Start adding now!<br />
      If that's not the case, you might be having connectivity issues. Try again later.
    </p>
  </div>
</ng-template>
